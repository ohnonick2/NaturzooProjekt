<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Benutzer bearbeiten</title>
  <div th:insert="~{vorlagen/icon :: icon}"></div>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('/images/background.png');
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
      overflow-x: hidden;
    }


    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    .main-content.collapsed {
      margin-left: 70px;
    }

    .card {
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .password-container {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #6c757d;
    }
    .autocomplete-suggestions {
      border: 1px solid #ddd;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: white;
      z-index: 1000;
      width: calc(100% - 20px);
      margin-left: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
    }
    .autocomplete-suggestion {
      padding: 10px;
      cursor: pointer;
    }

    .autocomplete-suggestion:hover {
      background: #f0f0f0;
    }
  </style>
</head>

<body>
<!-- Sidebar -->
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>

<div class="main-content" id="main-content">
  <h1>Benutzer bearbeiten</h1>
  <div class="card">
    <form id="editPflegerForm">
      <input type="hidden" id="pflegerId" th:value="${pfleger.id}" />

      <div class="mb-3">
        <label for="benutzername" class="form-label">Benutzername</label>
        <input type="text" class="form-control" id="benutzername" th:value="${pfleger.benutzername}" required />
      </div>

      <div class="mb-3">
        <label for="vorname" class="form-label">Vorname</label>
        <input type="text" class="form-control" id="vorname" th:value="${pfleger.vorname}" required />
      </div>

      <div class="mb-3">
        <label for="nachname" class="form-label">Nachname</label>
        <input type="text" class="form-control" id="nachname" th:value="${pfleger.nachname}" required />
      </div>

      <div class="mb-3">
        <label for="geburtstag" class="form-label">Geburtstag</label>
        <input type="date" class="form-control" id="geburtstag" th:value="${pfleger.geburtsdatum}" required />
      </div>

      <div class="mb-3">
        <label for="enabled" class="form-label">Aktiviert</label>
        <select class="form-control" id="enabled" required>
          <option value="true" th:selected="${pfleger.enabled} == true">Ja</option>
          <option value="false" th:selected="${pfleger.enabled} == false">Nein</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="role" class="form-label">Rolle</label>
        <select class="form-control" id="role" required>
          <option th:each="role : ${roles}" th:value="${role.name}" th:text="${role.name}"></option>
        </select>
      </div>

      <div class="mb-3 autocomplete-container">
        <label for="ort" class="form-label">Ort (PLZ oder Name suchen)</label>
        <input type="text" class="form-control" id="ort" placeholder="Ort suchen..." autocomplete="off" required />
        <input type="hidden" id="ortPlz" /> <!-- Versteckte Eingabe für PLZ -->
        <div id="autocomplete-suggestions" class="autocomplete-suggestions"></div>
        <ul id="orte-list" style="display: none;">
          <li th:each="ort : ${orte}" th:data-id="${ort.plz}" th:data-plz="${ort.plz}" th:data-name="${ort.ortname}">
            <span th:text="${ort.ortname} + ' (' + ${ort.plz} + ')'"></span>
          </li>
        </ul>
      </div>

      <div class="mb-3">
        <label for="password" class="form-label">Passwort</label>
        <div class="password-container">
          <input type="password" class="form-control" id="password" placeholder="Optional, leer lassen..." />
          <button type="button" class="toggle-password" onclick="togglePassword()">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>
      <small class="info-text">Nach dem Generieren oder manuellen Eingeben muss das Passwort gespeichert werden.</small>
      <div class="d-flex">
        <button type="button" class="btn btn-secondary me-2" onclick="generatePassword()">Passwort generieren</button>
        <button type="button" class="btn btn-primary" onclick="changePassword()">Passwort speichern</button>
      </div>

      <div class="d-flex justify-content-between mt-3">
        <button type="button" class="btn btn-secondary" onclick="goBack()">Abbrechen</button>
        <button type="submit" class="btn btn-primary">Speichern</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.getElementById('editPflegerForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const payload = {
      id: document.getElementById('pflegerId').value,
      benutzername: document.getElementById('benutzername').value,
      vorname: document.getElementById('vorname').value,
      nachname: document.getElementById('nachname').value,
      geburtstag: document.getElementById('geburtstag').value,
      enabled: document.getElementById('enabled').value === 'true',
      role: document.getElementById('role').value
    };

    fetch('/api/pfleger/edit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
            .then(response => {
              if (response.ok) {
                window.location.href = "/usermanagement";
              } else {
                alert('Fehler beim Bearbeiten.');
              }
            })
            .catch(error => alert('Fehler: ' + error));
  });

  function changePassword() {
    const password = document.getElementById('password').value;
    if (!password) {
      return alert('Passwort darf nicht leer sein.');
    }

    const payload = {
      id: document.getElementById('pflegerId').value,
      password: password
    };

    fetch('/api/pfleger/changePassword', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
            .then(response => {
              if (response.ok) {
                alert('Passwort erfolgreich geändert!');
              } else {
                alert('Fehler beim Ändern des Passworts.');
              }
            })
            .catch(error => alert('Fehler: ' + error));
  }

  function generatePassword() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@$!%*?&";
    let password = Array.from({ length: 12 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    document.getElementById('password').value = password;
  }

  function togglePassword() {
    const passwordInput = document.getElementById('password');
    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
  }

  function goBack() {
    window.history.back();
  }

  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('main-content').classList.toggle('collapsed');
  }
</script>
</body>

</html>
