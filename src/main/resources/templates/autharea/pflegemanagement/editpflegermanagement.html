<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Benutzer bearbeiten | Rheiner Zoo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('/images/background.png');
      margin: 0;
      padding: 20px;
      background-color: #f4f6f9;
    }
    .main-content {
      margin: 0 auto;
      max-width: 600px;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #1f4e3e;
      font-size: 24px;
      margin-bottom: 20px;
    }
    .btn-primary {
      background-color: #007bff;
      color: white;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    .password-container {
      position: relative;
    }
    .toggle-password {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #6c757d;
    }
    .info-text {
      font-size: 0.9em;
      color: #6c757d;
    }
    .autocomplete-container {
      position: relative;
    }
    .autocomplete-suggestions {
      position: absolute;
      z-index: 1000;
      background-color: white;
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
    }
    .autocomplete-suggestion {
      padding: 10px;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background-color: #f0f0f0;
    }
    footer {
      background-color: #343a40;
      color: #fff;
      padding: 20px 0;
      text-align: center;
    }
    footer a {
      color: #28a745;
      margin: 0 10px;
      font-size: 1.5rem;
      text-decoration: none;
    }
    footer p {
      margin-bottom: 0;
    }
    footer hr {
      border-color: rgba(255, 255, 255, 0.2);
    }
    .sidebar {
      width: 250px;
      height: 100vh;
      background-color: #1f4e3e;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      overflow: hidden;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .menu-toggle {
      text-align: center;
      padding: 10px;
      cursor: pointer;
      background-color: #218838;
      color: white;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      padding: 10px 15px;
      transition: all 0.3s ease;
    }

    .sidebar.collapsed a span {
      display: none;
    }

    .sidebar a:hover {
      background-color: #2c6e56;
    }

    .sidebar i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .sidebar.collapsed i {
      margin-right: 0;
      text-align: center;
      width: 100%;
    }

  </style>
</head>

<body>
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>

<div class="main-content">
  <h1>Benutzer bearbeiten</h1>
  <form id="editPflegerForm">
    <input type="hidden" id="pflegerId" th:value="${pfleger.id}" />

    <div class="mb-3">
      <label for="benutzername" class="form-label">Benutzername</label>
      <input type="text" class="form-control" id="benutzername" th:value="${pfleger.benutzername}" required />
    </div>

    <div class="mb-3">
      <label for="vorname" class="form-label">Vorname</label>
      <input type="text" class="form-control" id="vorname" th:value="${pfleger.vorname}" required />
    </div>

    <div class="mb-3">
      <label for="nachname" class="form-label">Nachname</label>
      <input type="text" class="form-control" id="nachname" th:value="${pfleger.nachname}" required />
    </div>

    <div class="mb-3">
      <label for="enabled" class="form-label">Aktiviert</label>
      <select class="form-control" id="enabled" required>
        <option value="true" th:selected="${pfleger.enabled} == true">Ja</option>
        <option value="false" th:selected="${pfleger.enabled} == false">Nein</option>
      </select>
    </div>

    <div class="mb-3 autocomplete-container">
      <label for="ort" class="form-label">Ort (PLZ oder Name suchen)</label>
      <input type="text" class="form-control" id="ort" placeholder="Ort suchen..." autocomplete="off"  required />
      <input type="hidden" id="ortPlz" /> <!-- Versteckte Eingabe für PLZ -->
      <div id="autocomplete-suggestions" class="autocomplete-suggestions"></div>
      <ul id="orte-list" style="display: none;">
        <li th:each="ort : ${orte}" th:data-id="${ort.plz}" th:data-plz="${ort.plz}" th:data-name="${ort.ortname}">
          <span th:text="${ort.ortname} + ' (' + ${ort.plz} + ')'"></span>
        </li>
      </ul>
    </div>

    <div class="mb-3">
      <label for="password" class="form-label">Passwort</label>
      <div class="password-container">
        <input type="password" class="form-control" id="password" placeholder="Optional, leer lassen, um es nicht zu ändern" />
        <button type="button" class="toggle-password" onclick="togglePassword()">
          <i class="fas fa-eye"></i>
        </button>
      </div>
      <small class="info-text">Nach dem Generieren oder manuellen Eingeben muss das Passwort gespeichert werden.</small>
      <div class="mt-2">
        <button type="button" class="btn btn-secondary" onclick="generatePassword()">Passwort generieren</button>
        <button type="button" class="btn btn-primary" onclick="changePassword()">Passwort speichern</button>
      </div>
    </div>

    <div class="d-flex justify-content-between">
      <button type="button" class="btn btn-secondary" onclick="goBack()">Abbrechen</button>
      <button type="submit" class="btn btn-primary">Speichern</button>
    </div>
  </form>
</div>

<footer th:replace="~{vorlagen/footer :: footer}"></footer>

<script>
  function selectOrt(plz, name) {
    document.getElementById('ort').value = name + ' (' + plz + ')';
    document.getElementById('ortPlz').value = plz;
    document.getElementById('autocomplete-suggestions').innerHTML = '';
  }

  document.getElementById('ort').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    const suggestionsBox = document.getElementById('autocomplete-suggestions');
    const ortList = document.querySelectorAll('#orte-list li');

    suggestionsBox.innerHTML = '';

    if (query.length > 2) {
      ortList.forEach(ort => {
        const ortName = ort.getAttribute('data-name').toLowerCase();
        const ortPlz = ort.getAttribute('data-plz');

        if (ortName.includes(query) || ortPlz.includes(query)) {
          const suggestion = document.createElement('div');
          suggestion.className = 'autocomplete-suggestion';
          suggestion.textContent = `${ort.getAttribute('data-name')} (${ortPlz})`;
          suggestion.onclick = () => selectOrt(ortPlz, ort.getAttribute('data-name'));
          suggestionsBox.appendChild(suggestion);
        }
      });
    }
  });

  document.getElementById('editPflegerForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const payload = {
      id: document.getElementById('pflegerId').value,
      benutzername: document.getElementById('benutzername').value,
      vorname: document.getElementById('vorname').value,
      nachname: document.getElementById('nachname').value,
      enabled: document.getElementById('enabled').value === 'true',
      ort: document.getElementById('ortPlz').value
              ? { plz: document.getElementById('ortPlz').value }
              : { plz: '${pfleger.ort}' }
    };


    fetch('/api/pfleger/edit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
            .then(response => response.ok ? alert('Erfolgreich bearbeitet!') : response.text().then(alert))
            .catch(() => alert('Fehler beim Bearbeiten.'));
  });

  function goBack() {
    window.history.back();
  }

  function generatePassword() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@$!%*?&";
    let password = Array.from({ length: 12 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    document.getElementById('password').value = password;
  }

  function togglePassword() {
    const passwordInput = document.getElementById('password');
    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
  }

  function changePassword() {
    const password = document.getElementById('password').value;
    if (!password) return alert('Passwort darf nicht leer sein.');

    fetch('/api/pfleger/changePassword', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: document.getElementById('pflegerId').value, password }),
    })
            .then(response => response.ok ? alert('Passwort geändert.') : response.text().then(alert))
            .catch(() => alert('Fehler beim Ändern des Passworts.'));
  }
</script>
</body>
</html>
