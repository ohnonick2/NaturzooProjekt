<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pflegermanagement | Rheiner Zoo</title>

  <div th:insert="~{vorlagen/icon :: icon}"></div>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/styles.css}">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f9;
    }
    .main-content {
      margin-left: 250px;
      padding: 20px;
    }
    .card {
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    .btn-primary, .btn-danger {
      color: white;
    }
  </style>
</head>

<body>

<!-- Sidebar -->
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>

<!-- Main Content -->
<div class="main-content">
  <div th:replace="~{vorlagen/header :: header(pageTitle='Pfleger Verwaltung - Rheiner Zoo')}"></div>

  <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addPflegerModal">
    <i class="fas fa-user-plus"></i> Pfleger hinzufügen
  </button>

  <!-- Suchfeld -->
  <div class="mt-3">
    <label for="searchInput"></label><input type="text" id="searchInput" class="form-control" placeholder="Pfleger suchen..." onkeyup="filterTable()">
  </div>

  <!-- Tabelle -->
  <div class="card mt-3">
    <h4>Pflegerübersicht</h4>
    <table class="table table-bordered">
      <thead>
      <tr>
        <th>ID</th>
        <th>Benutzername</th>
        <th>Vorname</th>
        <th>Nachname</th>
        <th>Geburtsdatum</th>
        <th>Ort</th>
        <th>Aktionen</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="user : ${usersWithRoles}">
        <td th:text="${user.pfleger.id}"></td>
        <td th:text="${user.pfleger.benutzername}"></td>
        <td th:text="${user.pfleger.vorname}"></td>
        <td th:text="${user.pfleger.nachname}"></td>
        <td th:text="${#temporals.format(user.pfleger.geburtsdatum, 'dd.MM.yyyy')}"></td>
        <td th:text="${user.pfleger.ort.ortname}"></td>
        <td>

          <div class="btn-group">
            <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              Aktionen
            </button>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item edit-btn" href="#"
                   onclick="openEditModal(this)"
                   th:data-id="${user.pfleger.id}"
                   th:data-username="${user.pfleger.benutzername}"
                   th:data-vorname="${user.pfleger.vorname}"
                   th:data-nachname="${user.pfleger.nachname}"
                   th:data-geburtsdatum="${user.pfleger.geburtsdatum}"
                   th:data-ort="${user.pfleger.ort.ortname}"
                   th:data-enabled="${user.pfleger.enabled}"
                   th:data-lockeduntil="${user.pfleger.lockedUntil}">
                  <i class="fas fa-edit"></i> Bearbeiten
                </a>
              </li>
              <li>
                <a class="dropdown-item delete-btn" href="#"
                   th:data-id="${user.pfleger.id}"
                   onclick="'deleteUser(${user.pfleger.id})'">
                  <i class="fas fa-trash"></i> Löschen
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#"
                   th:data-id="${user.pfleger.id}"
                   th:data-rolle="${user.roleNames}"
                   th:data-gesperrt="${user.pfleger.getLockedUntil() != null ? 'true' : 'false'}"
                   th:data-gesperrtbis="${user.pfleger.getLockedUntil() != null ? #temporals.format(user.pfleger.getLockedUntil(), 'dd.MM.yyyy HH:mm') : ''}"
                   onclick="openDetailsModal(this)">
                  <i class="fas fa-info-circle"></i> Mehr Info
                </a>
              </li>
            </ul>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal: Pfleger hinzufügen -->
  <div class="modal fade" id="addPflegerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Neuen Pfleger hinzufügen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addPflegerForm">
            <label>Benutzername</label>
            <input type="text" class="form-control mb-3" id="addBenutzername" required>
            <label>Vorname</label>
            <input type="text" class="form-control mb-3" id="addVorname" required>
            <label>Nachname</label>
            <input type="text" class="form-control mb-3" id="addNachname" required>
            <label>Geburtsdatum</label>
            <input type="date" class="form-control mb-3" id="addGeburtsdatum" required>
            <label>Ort</label>
            <input type="text" class="form-control mb-3" id="addOrt" list="ortList" required>
            <datalist id="addortList">
              <option th:each="ort : ${orte}" th:id="${ort.plz}" th:value="${ort.ortname}"></option>
            </datalist>
            <label>Passwort</label>
            <input type="password" class="form-control mb-3" id="addPasswort" required>
            <button type="submit" class="btn btn-success">Hinzufügen</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Pfleger bearbeiten -->
  <div class="modal fade" id="editPflegerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pfleger bearbeiten</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editPflegerForm">
            <input type="hidden" id="editId">
            <label>Benutzername</label>
            <input type="text" class="form-control mb-3" id="editBenutzername" required>
            <label>Vorname</label>
            <input type="text" class="form-control mb-3" id="editVorname" required>
            <label>Nachname</label>
            <input type="text" class="form-control mb-3" id="editNachname" required>
            <label>Geburtsdatum</label>
            <input type="date" class="form-control mb-3" id="editGeburtsdatum" required>
            <label>Ort</label>
            <input type="text" class="form-control mb-3" id="editOrt" list="ortList" required>
            <datalist id="ortList">
              <option th:each="ort : ${orte}" th:id="${ort.plz}" th:value="${ort.ortname}"></option>
            </datalist>
            <label>Aktiviert</label>
            <select class="form-control mb-3" id="editEnabled" required>
              <option value="true">Ja</option>
              <option value="false">Nein</option>
            </select>
            <label>Gesperrt bis</label>
            <input type="datetime-local" class="form-control mb-3" id="editLockedUntil">
            <button type="submit" class="btn btn-primary">Speichern</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="detailsPflegerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pfleger Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>ID:</strong> <span id="detailsId"></span></p>
          <p><strong>Rolle:</strong> <span id="detailsRolle"></span></p>
          <p><strong>Gesperrt:</strong> <span id="detailsGesperrt"></span></p>
          <div id="gesperrtDetails" style="display: none;">
            <p><strong>Gesperrt bis:</strong> <span id="detailsGesperrtBis"></span></p>
          </div>

        </div>
      </div>
    </div>
  </div>


</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function openEditModal(button) {
    document.getElementById("editId").value = button.getAttribute("data-id");
    document.getElementById("editBenutzername").value = button.getAttribute("data-username");
    document.getElementById("editVorname").value = button.getAttribute("data-vorname");
    document.getElementById("editNachname").value = button.getAttribute("data-nachname");
    document.getElementById("editGeburtsdatum").value = button.getAttribute("data-geburtsdatum") || "";
    document.getElementById("editOrt").value = button.getAttribute("data-ort") || "";
    document.getElementById("editEnabled").value = button.getAttribute("data-enabled") === "true" ? "true" : "false";
    document.getElementById("editLockedUntil").value = button.getAttribute("data-lockeduntil") || "";

    new bootstrap.Modal(document.getElementById("editPflegerModal")).show();
  }

  async function deleteUser(id) {
    if (!confirm("Möchtest du diesen Pfleger wirklich löschen?")) return;

    const response = await fetch("/api/pfleger/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id })
    });

    if (response.ok) {
      alert("✅ Pfleger erfolgreich gelöscht!");
      location.reload();
    } else {
      alert("❌ Fehler beim Löschen des Pflegers!");
    }
  }

  document.getElementById("addPflegerForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    const benutzername = document.getElementById("addBenutzername").value;
    const vorname = document.getElementById("addVorname").value;
    const nachname = document.getElementById("addNachname").value;
    const geburtsdatum = document.getElementById("addGeburtsdatum").value;
    const ort = document.getElementById("addOrt").value;
    const passwort = document.getElementById("addPasswort").value;

    const response = await fetch("/api/pfleger/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ benutzername, vorname, nachname, geburtsdatum, ort , passwort })
    });

    if (response.ok) {
      alert("✅ Pfleger erfolgreich hinzugefügt!");
      location.reload();
    } else {
      alert("❌ Fehler beim Hinzufügen des Pflegers!");
    }
  });

  document.getElementById("editPflegerForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    const id = document.getElementById("editId").value;
    const benutzername = document.getElementById("editBenutzername").value;
    const vorname = document.getElementById("editVorname").value;
    const nachname = document.getElementById("editNachname").value;
    const geburtsdatum = document.getElementById("editGeburtsdatum").value;
    const ort = document.getElementById("editOrt").value;
    const enabled = document.getElementById("editEnabled").value;
    const lockedUntil = document.getElementById("editLockedUntil").value;

    const response = await fetch("/api/pfleger/edit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, benutzername, vorname, nachname, geburtsdatum, ort, enabled, lockedUntil })
    });

    if (response.ok) {
      alert("✅ Pfleger erfolgreich bearbeitet!");
      location.reload();
    } else {
      alert("❌ Fehler beim Bearbeiten des Pflegers!");
    }
  });

  function openDetailsModal(button) {
    document.getElementById("detailsId").innerText = button.getAttribute("data-id");

    const roles = button.getAttribute("data-rolle");
    if (roles) {
      document.getElementById("detailsRolle").innerText = roles.split(',').join(', ');
    } else {
      document.getElementById("detailsRolle").innerText = "Keine Rolle";
    }

    const gesperrt = button.getAttribute("data-gesperrt") === "true";
    document.getElementById("detailsGesperrt").innerText = gesperrt ? "Ja" : "Nein";
    if (gesperrt) {
      document.getElementById("gesperrtDetails").style.display = "block";
      document.getElementById("detailsGesperrtBis").innerText = button.getAttribute("data-gesperrtbis") || "N/A";
    } else {
      document.getElementById("detailsGesperrt").innerText = "Nicht gesperrt";
      document.getElementById("gesperrtDetails").style.display = "none";
    }
    new bootstrap.Modal(document.getElementById("detailsPflegerModal")).show();
  }

</script>

</body>
</html>