<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rollenverwaltung | Rheiner Zoo</title>

  <div th:insert="~{vorlagen/icon :: icon}"></div>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <style>
    body { background-color: #f4f6f9; font-family: Arial, sans-serif; }
    .main-content { margin-left: 250px; padding: 20px; }
    .card { border: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); padding: 20px; }
    .btn-primary, .btn-danger { color: white; }
    .accordion-button { background-color: #1f4e3e; color: white; }
  </style>
</head>

<body>
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>
<div class="main-content">
  <div th:replace="~{vorlagen/header :: header(pageTitle='Rollenverwaltung - Rheiner Zoo')}"></div>

  <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addRolleModal">
    <i class="fas fa-user-plus"></i> Rolle hinzufügen
  </button>

  <div class="card mt-3">
    <h4>Rollenübersicht</h4>
    <table class="table table-bordered">
      <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Gewichtung <i class="fas fa-info-circle" title="Je höher die Gewichtung, desto mehr Rechte"></i></th>
        <th>Aktionen</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="rolle : ${rollen}">
        <td th:text="${rolle.id}"></td>
        <td th:text="${rolle.name}"></td>
        <td>
          <span th:text="${rolle.weight}"></span>
        </td>
        <td>
          <div class="btn-group">
            <button class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">Aktionen</button>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item edit-btn" href="#"
                   th:data-id="${rolle.id}" th:data-name="${rolle.name}" th:data-weight="${rolle.weight}"
                   th:disabled="${rolle.weight >= currentUserWeight}"
                   onclick="openEditModal(this)">
                  <i class="fas fa-edit"></i> Bearbeiten
                </a>
              </li>
              <li>
                <a class="dropdown-item delete-btn text-danger" href="#"
                   th:data-id="${rolle.id}" th:disabled="${rolle.weight >= currentUserWeight}"
                   onclick="deleteRolle(this)">
                  <i class="fas fa-trash"></i> Löschen
                </a>
              </li>
            </ul>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Bearbeitungsmodal -->
<!-- Bearbeitungsmodal -->
<div class="modal fade" id="editRolleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Rolle bearbeiten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="editTab">
          <li class="nav-item"><a class="nav-link active" href="#editGeneral" data-bs-toggle="tab">Allgemein</a></li>
          <li class="nav-item"><a class="nav-link" href="#editPermissions" data-bs-toggle="tab">Berechtigungen</a></li>
          <li class="nav-item"><a class="nav-link" href="#editCaretakers" data-bs-toggle="tab">Pflegekräfte</a></li>
        </ul>

        <div class="tab-content mt-3">
          <!-- Allgemeine Daten -->
          <div class="tab-pane fade show active" id="editGeneral">
            <form id="editRolleForm">
              <input type="hidden" id="editRoleId">
              <label>Name</label>
              <input type="text" id="editRolename" class="form-control mb-3" required>
              <label>Gewichtung</label>
              <input type="number" id="editRoleWeight" class="form-control mb-3" required>
            </form>
          </div>

          <!-- Berechtigungen -->
          <div class="tab-pane fade" id="editPermissions">
            <h5>Berechtigungen verwalten</h5>
            <ul class="list-group">
              <li class="list-group-item" th:each="permission : ${permissions}">
                <input type="checkbox" th:id="'perm-' + ${permission.id}" th:value="${permission.id}"
                       th:checked="${permission.selected}" onchange="togglePermission(this)">
                <label th:for="'perm-' + ${permission.id}" th:text="${permission.permission}"></label>
              </li>
            </ul>
          </div>

          <!-- Pflegekräfte -->
          <div class="tab-pane fade" id="editCaretakers">
            <h5>Zugewiesene Pflegekräfte</h5>
            <ul class="list-group">
              <li class="list-group-item" th:each="user : ${rolleUserList}">
                <span th:text="${user.user.benutzername}"></span>
                <button class="btn btn-danger btn-sm float-end" onclick="removeCaretaker(this)" th:data-id="${user.user.id}">
                  <i class="fas fa-user-minus"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        <button type="submit" class="btn btn-success" onclick="saveRoleChanges()">Speichern</button>
      </div>
    </div>
  </div>
</div>


<script>
  // Öffnet das Modal und lädt aktuelle Daten
  function openEditModal(button) {
    document.getElementById("editRoleId").value = button.getAttribute("data-id");
    document.getElementById("editRolename").value = button.getAttribute("data-name");
    document.getElementById("editRoleWeight").value = button.getAttribute("data-weight");

    // Berechtigungen aktualisieren
    loadPermissions(button.getAttribute("data-id"));

    new bootstrap.Modal(document.getElementById("editRolleModal")).show();
  }

  // Berechtigungen per API abrufen und Checkboxen aktualisieren
  async function loadPermissions(roleId) {
    const response = await fetch(`/api/permissions/getPermissions?roleId=${roleId}`);
    const permissions = await response.json();

    permissions.forEach(permission => {
      const checkbox = document.getElementById(`perm-${permission.id}`);
      if (checkbox) {
        checkbox.checked = permission.assigned;
      }
    });
  }

  // Berechtigungen hinzufügen oder entfernen
  async function togglePermission(checkbox) {
    const roleId = document.getElementById("editRoleId").value;
    const permissionId = checkbox.value;
    const action = checkbox.checked ? "addPermission" : "removePermission";

    const response = await fetch(`/api/permissions/${action}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ roleId, permissionId })
    });

    if (!response.ok) {
      alert("❌ Fehler beim Aktualisieren der Berechtigungen!");
      checkbox.checked = !checkbox.checked; // Zurücksetzen, falls Fehler auftritt
    }
  }

  // Speichert Änderungen an der Rolle
  async function saveRoleChanges() {
    const roleId = document.getElementById("editRoleId").value;
    const roleName = document.getElementById("editRolename").value;
    const roleWeight = document.getElementById("editRoleWeight").value;

    const response = await fetch("/api/permissions/editRole", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: roleId, name: roleName, weight: roleWeight })
    });

    if (response.ok) {
      alert("✅ Änderungen gespeichert!");
      location.reload();
    } else {
      alert("❌ Fehler beim Speichern!");
    }
  }

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
