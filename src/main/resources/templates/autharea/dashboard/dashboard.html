<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Management | Rheiner Zoo</title>
  <div th:insert="~{vorlagen/icon :: icon}"></div>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* Allgemeines Styling */
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Hauptcontainer */
    .main-content {
      margin-left: 250px;
      padding: 20px;
      flex: 1;
    }

    .main-content.collapsed {
      margin-left: 70px;
    }

    /* Header */
    .main-header {
      background: #1f4e3e;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      border-radius: 6px;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Benachrichtigungs-Icon */
    .notification-icon {
      position: relative;
      font-size: 22px;
      cursor: pointer;
      margin-right: 20px;
    }

    .notification-icon .fa-bell {
      color: white;
    }

    /* Roter Punkt f√ºr neue Nachrichten */
    .notification-icon .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      font-size: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: none;
    }

    /* Dropdown-Men√º f√ºr Benachrichtigungen */
    .notification-dropdown {
      position: absolute;
      top: 40px;
      right: 20px;
      background: white;
      color: black;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      width: 250px;
      display: none;
      padding: 10px;
      z-index: 1000;
    }

    .notification-dropdown.active {
      display: block;
    }

    .notification-dropdown .notification-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    .notification-dropdown .notification-item:last-child {
      border-bottom: none;
    }

    .notification-dropdown .notification-item .close-btn {
      background: none;
      border: none;
      font-size: 14px;
      color: red;
      cursor: pointer;
    }

    /* Button f√ºr "Alle l√∂schen" */
    .clear-all {
      display: none;
      text-align: center;
      padding: 10px;
      font-size: 14px;
      color: red;
      cursor: pointer;
      border-top: 1px solid #ddd;
      background: #f8f9fa;
    }

    /* Karten */
    .card {
      background: white;
      border-radius: 8px;
      border: none;
      padding: 15px;
      margin-bottom: 15px;
    }

    /* Footer minimal halten */
    footer {
      background-color: #212529;
      color: #bbb;
      padding: 10px 0;
      font-size: 14px;
      text-align: center;
    }

    footer a {
      color: #28a745;
      text-decoration: none;
      font-size: 14px;
    }

    footer a:hover {
      text-decoration: underline;
    }

  </style>
</head>

<body>

<!-- Sidebar -->
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>

<!-- Main Content -->
<div class="main-content" id="main-content">


  <div th:insert="~{vorlagen/header :: header(pageTitle='Admin Management - Rheiner Zoo')}"></div>



    <!-- üìç Zugewiesenes Revier -->
  <div class="card">
    <h4>Dein Revier</h4>
    <p>üìç Zugewiesene Reviere: <span th:text="${revierText}"></span></p>
    <p>üêò Anzahl der Tiere: <strong th:text="${anzahlTiere}" ></strong></p>
  </div>
  <p id="pfleger-id" th:text="${id}" style="display: none;"></p>

  <!-- ü¶Å Aktuelle F√ºtterungen -->
  <div class="card">
    <h4>Aktuelle F√ºtterungen</h4>
    <table class="table table-bordered">
      <thead>
      <tr>
        <th>Futterplan Name</th>
        <th>Futter</th>
        <th>Uhrzeit</th>
      </tr>
      </thead>
      <tbody>
      <tr th:if="${#lists.isEmpty(futterplaene)}">
        <td colspan="3" class="text-center">üö® Heute sind keine F√ºtterungen geplant.</td>
      </tr>
      <tr th:each="futterplan : ${futterplaene}">
        <td th:text="${futterplan.name}"></td>
        <td>
          <ul>

            <div th:each="futter : ${futterplan.futter}">
              <li th:text="${futter.name}"></li>
            </div>

          </ul>
        </td>
        <div th:each="uhrzeit : ${futterplan.getFutterzeiten()}">
          <td th:text="${uhrzeit.uhrzeit}"></td>
        </div>
      </tr>
      </tbody>
    </table>
  </div>

</div>

<!-- Footer -->
<footer th:insert="~{vorlagen/footer :: footer}"></footer>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const pflegerIdElement = document.getElementById("pfleger-id");
    const pflegerId = pflegerIdElement ? pflegerIdElement.textContent.trim() : null;

    if (!pflegerId) {
      console.error("Pfleger-ID nicht gefunden oder leer.");
      return;
    }

    console.log("Pfleger-ID:", pflegerId);

    const notificationIcon = document.getElementById("notification-icon");
    const notificationDropdown = document.getElementById("notification-dropdown");
    const notificationBadge = document.getElementById("notification-badge");
    const clearAllButton = document.getElementById("clear-all");

    /** üõ† FIX: Glocke klickbar machen **/
    notificationIcon.addEventListener("click", function(event) {
      event.stopPropagation(); // Verhindert unerw√ºnschtes Schlie√üen
      notificationDropdown.classList.toggle("active");

      // üîπ Falls ge√∂ffnet, rotes Badge ausblenden
      if (notificationDropdown.classList.contains("active")) {
        notificationBadge.style.display = "none";
      }
    });

    // üõ† Klicken au√üerhalb schlie√üt Dropdown
    document.addEventListener("click", function(event) {
      if (!notificationIcon.contains(event.target) && !notificationDropdown.contains(event.target)) {
        notificationDropdown.classList.remove("active");
      }
    });

    function updateNotificationState() {
      const notifications = document.querySelectorAll(".notification-item");
      if (notifications.length === 0) {
        notificationBadge.style.display = "none";
        clearAllButton.style.display = "none";
        notificationDropdown.innerHTML = '<p class="text-center text-muted">Keine neuen Nachrichten</p>';
      } else {
        clearAllButton.style.display = "block";
      }
    }

    // üïí Countdown-Timer f√ºr Nachrichten, die bald gel√∂scht werden
    function updateCountdown() {
      const now = Date.now();
      document.querySelectorAll(".countdown").forEach(countdownElement => {
        const deleteOn = parseInt(countdownElement.getAttribute("data-deleteon"));
        const timeLeft = deleteOn - now;

        if (timeLeft <= 0) {
          // Nachricht automatisch entfernen, wenn sie abgelaufen ist
          const notificationItem = countdownElement.closest(".notification-item");
          if (notificationItem) {
            notificationItem.remove();
            updateNotificationState();
          }
        } else if (timeLeft < 300000) { // Falls weniger als 5 Minuten √ºbrig
          const minutes = Math.floor(timeLeft / 60000);
          const seconds = Math.floor((timeLeft % 60000) / 1000);
          countdownElement.textContent = `${minutes}m ${seconds}s`;
        } else {
          const date = new Date(deleteOn);
          countdownElement.textContent = date.toLocaleString("de-DE");
        }
      });
    }

    setInterval(updateCountdown, 1000); // Jede Sekunde aktualisieren

    // Einzelne Benachrichtigung als gelesen markieren
    document.addEventListener("click", function(event) {
      if (event.target.classList.contains("close-btn")) {
        const notificationId = event.target.getAttribute("data-id");

        fetch("/api/notification/markasread", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ notificationId: notificationId, pflegerId: pflegerId })
        }).then(response => {
          if (response.ok) {
            event.target.parentElement.remove();
            updateNotificationState();
          }
        }).catch(error => console.error("Fehler beim Markieren als gelesen:", error));
      }
    });

    // Alle Benachrichtigungen als gelesen markieren
    if (clearAllButton) {
      clearAllButton.addEventListener("click", function() {
        fetch("/api/notification/markasread", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ pflegerId: pflegerId })
        }).then(response => {
          if (response.ok) {
            document.querySelectorAll(".notification-item").forEach(item => item.remove());
            updateNotificationState();
          }
        }).catch(error => console.error("Fehler beim Markieren aller als gelesen:", error));
      });
    }

    updateNotificationState();
    updateCountdown();
  });
</script>



</body>
</html>
