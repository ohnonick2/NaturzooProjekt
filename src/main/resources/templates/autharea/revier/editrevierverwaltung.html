<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revier Bearbeiten</title>
    <div th:insert="~{vorlagen/icon :: icon}"></div>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        .main-content {
            max-width: 1000px;
            margin: auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            background-color: #1f4e3e;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .btn-custom {
            min-width: 150px;
            margin: 5px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background-color: #1f4e3e;
            color: white;
        }

        .table td, .table th {
            padding: 10px;
            text-align: left;
        }

        .btn-danger, .btn-success {
            min-width: 120px;
        }
    </style>
</head>

<body>

<!-- Sidebar -->
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>

<!-- Hauptinhalt -->
<div class="main-content">
    <div class="header">
        <h2>Revier Bearbeiten</h2>
    </div>

    <!-- Revier Formular -->
    <div class="card p-4">
        <form id="editRevierForm" onsubmit="submitForm(event)">
            <div class="mb-3">
                <label for="revierName" class="form-label">Revier Name</label>
                <input type="hidden" id="id" name="id" th:value="${revier.id}">
                <input type="text" class="form-control" id="revierName" name="name" th:value="${revier.name}" required>
            </div>
            <button type="submit" class="btn btn-primary btn-custom">Speichern</button>
        </form>

        <!-- Pfleger Verwaltung -->
        <h4 class="mt-4">Pfleger Verwaltung</h4>
        <div class="d-flex mb-3">
            <select id="availableCaretaker" class="form-control">
                <option value="">Bitte wählen...</option>
                <option th:each="pfleger : ${verfuegbarePfleger}" th:value="${pfleger.id}" th:text="${pfleger.benutzername}"></option>
            </select>
            <button class="btn btn-success ms-2" onclick="addCaretaker()">Hinzufügen</button>
        </div>

        <table class="table table-striped">
            <thead>
            <tr>
                <th>Benutzername</th>
                <th>Vorname</th>
                <th>Nachname</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="pfleger : ${revierPflegerList}">
                <td th:text="${pfleger.pfleger.benutzername}"></td>
                <td th:text="${pfleger.pfleger.vorname}"></td>
                <td th:text="${pfleger.pfleger.nachname}"></td>
                <td>
                    <button class="btn btn-danger" onclick="removeCaretaker(this, ${pfleger.pfleger.id})">Entfernen</button>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Tierverwaltung -->
        <h4 class="mt-4">Tiere Verwaltung</h4>
        <div class="d-flex mb-3">
            <select id="availableTier" class="form-control">
                <option value="">Bitte wählen...</option>
                <option th:each="tier : ${verfuegbareTiere}" th:value="${tier.id}" th:text="${tier.name}"></option>
            </select>
            <button class="btn btn-success ms-2" onclick="addTier()">Tier hinzufügen</button>
        </div>

        <table class="table table-striped">
            <thead>
            <tr>
                <th>Name</th>
                <th>Art</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="tier : ${revierTiere}">
                <td th:text="${tier.tierId.name}"></td>
                <td th:text="${tier.tierId.tierArt.name}"></td>
                <td>
                    <button class="btn btn-danger" onclick="removeTier(this, ${tier.tierId.id})">Entfernen</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- JavaScript -->
<script>
    async function submitForm(event) {
        event.preventDefault();
        const id = document.getElementById('id').value;
        const name = document.getElementById('revierName').value;

        const response = await fetch('/api/revier/edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, name })
        });

        if (response.ok) {
            alert('Revier erfolgreich aktualisiert!');
            location.reload();
        } else {
            alert('Fehler beim Speichern!');
        }
    }

    async function addCaretaker() {
        const revierId = document.getElementById('id').value;
        const pflegerId = document.getElementById('availableCaretaker').value;

        if (!pflegerId) {
            alert('Bitte wählen Sie einen Pfleger aus!');
            return;
        }

        await fetch(`/api/revier/addPfleger`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ revierId, pflegerId })
        }).then(() => location.reload());
    }

    async function removeCaretaker(button, pflegerId) {
        if (!confirm('Möchten Sie diesen Pfleger wirklich entfernen?')) return;
        await fetch(`/api/revier/removePfleger`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ revierId: document.getElementById('id').value, pflegerId })
        }).then(() => button.closest('tr').remove());
    }

    async function addTier() {
       window.location.href = `/addTier/}`;
    }
</script>

</body>
</html>
