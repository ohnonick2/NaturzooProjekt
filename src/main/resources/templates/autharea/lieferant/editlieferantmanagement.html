<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Lieferant bearbeiten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <div th:insert="~{vorlagen/icon :: icon}"></div>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('/images/background.png');
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
      overflow-x: hidden;
    }

    /* Sidebar & Main Content */
    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: margin-left 0.3s ease-in-out;
    }

    .main-content.collapsed {
      margin-left: 70px;
    }

    .card {
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 20px;
      border-radius: 10px;
      background-color: #ffffff;
    }

    .header {
      background-color: #1f4e3e;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 8px;
    }

    .btn-primary {
      background-color: #218838;
      border-color: #218838;
    }

    .btn-primary:hover {
      background-color: #1c7430;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
<!-- Sidebar über Thymeleaf laden -->
<div th:insert="~{vorlagen/sidebar :: sidebar}" id="sidebar" class="sidebar"></div>

<!-- Main Content -->
<div class="main-content" id="main-content">
  <div class="container">
    <div class="header">
      <h2>Lieferantenverwaltung</h2>
    </div>

    <div class="card mt-4">
      <h4 class="mb-3">
        <i class="fas fa-truck"></i> Lieferant bearbeiten: <span th:text="${lieferant.name}"></span>
      </h4>

      <form id="editLieferantForm">
        <input type="hidden" id="lieferantId" name="id" th:value="${lieferant.id}">

        <label for="name" class="form-label">Lieferantenname</label>
        <input type="text" id="name" name="name" class="form-control" th:value="${lieferant.name}" required>

        <label for="telefon" class="form-label">Telefonnummer</label>
        <input type="text" id="telefon" name="telefon" class="form-control" th:value="${lieferant.telefonnummer}" required>

        <label for="ansprechpartner" class="form-label">Ansprechpartner</label>
        <input type="text" id="ansprechpartner" name="ansprechpartner" class="form-control" th:value="${lieferant.ansprechpartner}" required>

        <label for="adresse" class="form-label">Adresse</label>
        <select id="adresse" name="adresseId" class="form-select" onchange="toggleNeueAdresse()">
          <option value="" disabled>Wähle eine Adresse</option>
          <option th:each="adresse : ${adressen}"
                  th:value="${adresse.id}"
                  th:text="${adresse.strasse} + ' ' + ${adresse.hausnummer} + ', ' + ${adresse.ort.plz} + ' ' + ${adresse.ort.ortname}"
                  th:selected="${lieferant.adresse.id == adresse.id}">
          </option>
          <option value="neu">Neue Adresse hinzufügen</option>
        </select>

        <!-- Neue Adresse Felder -->
        <div id="neueAdresseContainer" class="hidden mt-3">
          <h5>Neue Adresse hinzufügen</h5>
          <input type="text" id="strasse" name="strasse" class="form-control" placeholder="Straße">
          <input type="text" id="hausnummer" name="hausnummer" class="form-control" placeholder="Hausnummer">
          <input type="text" id="plz" name="plz" class="form-control" placeholder="PLZ">
          <input type="text" id="ortname" name="ortname" class="form-control" placeholder="Ort">
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Änderungen speichern
          </button>
          <a href="/lieferanten" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Abbrechen
          </a>
        </div>

        <div id="feedbackMessage" class="mt-3"></div>
      </form>
    </div>
  </div>
</div>

<!-- Footer -->
<footer th:insert="~{vorlagen/footer :: footer}"></footer>

<script>
  function toggleNeueAdresse() {
    const adresseDropdown = document.getElementById('adresse');
    const neueAdresseContainer = document.getElementById('neueAdresseContainer');
    neueAdresseContainer.style.display = adresseDropdown.value === 'neu' ? 'block' : 'none';
  }

  document.getElementById('editLieferantForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    let payload = {
      id: document.getElementById('lieferantId').value,
      name: document.getElementById('name').value,
      telefon: document.getElementById('telefon').value,
      ansprechpartner: document.getElementById('ansprechpartner').value
    };

    if (document.getElementById('adresse').value === 'neu') {
      payload.adresse = {
        strasse: document.getElementById('strasse').value,
        hausnummer: document.getElementById('hausnummer').value,
        plz: document.getElementById('plz').value,
        ortname: document.getElementById('ortname').value
      };
    } else {
      payload.adresseId = document.getElementById('adresse').value;
    }

    try {
      const response = await axios.post('/api/lieferant/edit', payload);

      if (response.status === 200) {
        document.getElementById('feedbackMessage').innerHTML = `<div class="alert alert-success">Änderungen gespeichert!</div>`;
        setTimeout(() => window.location.href = "/lieferanten", 1000);
      } else {
        throw new Error('Fehler beim Speichern.');
      }
    } catch (error) {
      document.getElementById('feedbackMessage').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
  });

  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('main-content').classList.toggle('collapsed');
  }
</script>

</body>
</html>
