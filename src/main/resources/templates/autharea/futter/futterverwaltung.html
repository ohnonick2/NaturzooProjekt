<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futterverwaltung | Rheiner Zoo</title>

    <div th:insert="~{vorlagen/icon :: icon}"></div>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f6f9; }
        .main-content { margin-left: 250px; padding: 20px; }
        .card { border: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); padding: 20px; }
        .btn-primary, .btn-danger { color: white; }
    </style>
</head>

<body>

<!-- Sidebar -->
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>

<!-- Main Content -->
<div class="main-content">
    <div th:replace="~{vorlagen/header :: header(pageTitle='Futterverwaltung - Rheiner Zoo')}"></div>

    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addFoodModal">
        <i class="fas fa-plus"></i> Futter hinzufügen
    </button>

    <!-- Suchfeld -->
    <div class="mt-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Futter suchen..." onkeyup="filterTable()">
    </div>

    <!-- Tabelle -->
    <div class="card mt-3">
        <h4>Futterübersicht</h4>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Menge</th>
                <th>Lieferant</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="food : ${futterList}">
                <td th:text="${food.id}"></td>
                <td th:text="${food.name}"></td>
                <td th:text="${food.menge}"></td>
                <td th:text="${food.lieferant.name}"></td>
                <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            Aktionen
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item edit-btn" href="#"
                                   th:data-id="${food.id}"
                                   th:data-name="${food.name}"
                                   th:data-menge="${food.menge}"
                                   th:data-lieferantid="${food.lieferant.id}"
                                   onclick="openEditModal(this)">
                                    <i class="fas fa-edit"></i> Bearbeiten
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item delete-btn" href="#"
                                   th:data-id="${food.id}"
                                   onclick="deleteFood(this)">
                                    <i class="fas fa-trash"></i> Löschen
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal: Futter bearbeiten -->
    <div class="modal fade" id="editFoodModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Futter bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editFoodForm">
                        <input type="hidden" id="editId">

                        <label for="editName">Name</label>
                        <input type="text" class="form-control mb-3" id="editName" required>

                        <label for="editMenge">Menge</label>
                        <input type="number" class="form-control mb-3" id="editMenge" required>

                        <label for="editLieferant">Lieferant</label>
                        <div class="input-group mb-3">
                            <select class="form-select" id="editLieferant" required>
                                <option value="">Lieferant auswählen</option>
                                <option th:each="lieferant : ${lieferanten}"
                                        th:value="${lieferant.id}"
                                        th:text="${lieferant.name}">
                                </option>
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="addNewSupplier()">+</button>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">Speichern</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal: Futter hinzufügen -->
    <div class="modal fade" id="addFoodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neues Futter hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addFoodForm">
                        <label>Name</label>
                        <input type="text" class="form-control mb-3" id="addName" required>
                        <label>Menge</label>
                        <input type="number" class="form-control mb-3" id="addMenge" required>

                        <label>Lieferant</label>
                        <div class="input-group mb-3">
                            <select class="form-select" id="addLieferant" required>
                                <option value="">Lieferant auswählen</option>
                                <option th:each="lieferant : ${lieferanten}" th:value="${lieferant.id}" th:text="${lieferant.name}"></option>
                            </select>
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">+</button>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-success">Hinzufügen</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Neuen Lieferanten hinzufügen -->
    <div class="modal fade" id="addSupplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuen Lieferanten hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addSupplierForm">
                        <!-- Name des Lieferanten -->
                        <label for="addSupplierName">Name des Lieferanten</label>
                        <input type="text" class="form-control mb-3" id="addSupplierName" required>

                        <!-- Telefonnummer -->
                        <label for="addSupplierPhone">Telefonnummer</label>
                        <input type="tel" class="form-control mb-3" id="addSupplierPhone" required>

                        <!-- Ansprechpartner -->
                        <label for="addSupplierContact">Ansprechpartner</label>
                        <input type="text" class="form-control mb-3" id="addSupplierContact">

                        <!-- Adresse auswählen oder neue erstellen -->
                        <label for="existingAddress">Adresse auswählen</label>
                        <select class="form-select mb-3" id="existingAddress" onchange="fillAddressFields()">
                            <option value="">Neue Adresse erstellen</option>
                            <option th:each="adresse : ${adressen}"
                                    th:value="${adresse.id}"
                                    th:data-strasse="${adresse.strasse}"
                                    th:data-hausnummer="${adresse.hausnummer}"
                                    th:data-plz="${adresse.ort.plz}"
                                    th:data-ort="${adresse.ort.ortname}"
                                    th:text="${adresse.strasse} + ' ' + ${adresse.hausnummer} + ', ' + ${adresse.ort.ortname}">
                            </option>
                        </select>

                        <div id="newAddressFields">
                            <label for="addSupplierStreet">Straße</label>
                            <input type="text" class="form-control mb-3" id="addSupplierStreet">

                            <label for="addSupplierHouseNumber">Hausnummer</label>
                            <input type="text" class="form-control mb-3" id="addSupplierHouseNumber">

                            <!-- PLZ & Ort mit Dropdown -->
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="addSupplierPLZ">PLZ</label>
                                    <input type="text" class="form-control mb-3" id="addSupplierPLZ">
                                </div>
                                <div class="col-md-6">
                                    <label for="addSupplierCity">Ort</label>
                                    <select class="form-select mb-3" id="addSupplierCity" onchange="updatePLZ()">
                                        <option value="" selected disabled>Ort auswählen...</option>
                                        <option th:each="ort : ${orte}"
                                                th:value="${ort.ortname}"
                                                th:data-plz="${ort.plz}"
                                                th:text="${ort.ortname}">
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-success">Hinzufügen</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>




</div>

<script>
    function openEditModal(button) {
        document.getElementById("editId").value = button.getAttribute("data-id");
        document.getElementById("editName").value = button.getAttribute("data-name");
        document.getElementById("editMenge").value = button.getAttribute("data-menge");
        document.getElementById("editLieferant").value = button.getAttribute("data-lieferantid");
        new bootstrap.Modal(document.getElementById("editFoodModal")).show();
    }



    async function deleteFood(button) {
        if (!confirm("Möchtest du dieses Futter wirklich löschen?")) return;
        const id = button.getAttribute("data-id");
        const response = await fetch("/api/food/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
        });

        if (response.ok) {
            alert("Futter erfolgreich gelöscht!");
            location.reload();
        } else {
            alert("Fehler beim Löschen des Futters!");
        }
    }

    function updatePLZ() {
        let cityDropdown = document.getElementById("addSupplierCity");
        let selectedOption = cityDropdown.options[cityDropdown.selectedIndex];
        let plzField = document.getElementById("addSupplierPLZ");

        if (selectedOption && selectedOption.getAttribute("data-plz")) {
            plzField.value = selectedOption.getAttribute("data-plz");
        }
    }

    function fillAddressFields() {
        let addressDropdown = document.getElementById("existingAddress");
        let selectedOption = addressDropdown.options[addressDropdown.selectedIndex];

        if (selectedOption.value) {
            document.getElementById("addSupplierStreet").value = selectedOption.getAttribute("data-strasse");
            document.getElementById("addSupplierHouseNumber").value = selectedOption.getAttribute("data-hausnummer");
            document.getElementById("addSupplierPLZ").value = selectedOption.getAttribute("data-plz");
            document.getElementById("addSupplierCity").value = selectedOption.getAttribute("data-ort");
            document.getElementById("newAddressFields").style.display = "none";
        } else {
            document.getElementById("addSupplierStreet").value = "";
            document.getElementById("addSupplierHouseNumber").value = "";
            document.getElementById("addSupplierPLZ").value = "";
            document.getElementById("addSupplierCity").value = "";
            document.getElementById("newAddressFields").style.display = "block";
        }
    }

    // Lieferant hinzufügen (inkl. Adresse)
    document.getElementById("addSupplierForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        // Eingaben abrufen
        const name = document.getElementById("addSupplierName").value.trim();
        const telefon = document.getElementById("addSupplierPhone").value.trim();
        const ansprechpartner = document.getElementById("addSupplierContact").value.trim() || null;
        const existingAddressId = document.getElementById("existingAddress").value;

        let adresse = {};

        if (existingAddressId) {
            adresse = { id: existingAddressId };
        } else {
            adresse = {
                strasse: document.getElementById("addSupplierStreet").value.trim(),
                hausnummer: document.getElementById("addSupplierHouseNumber").value.trim(),
                plz: document.getElementById("addSupplierPLZ").value.trim(),
                ortname: document.getElementById("addSupplierCity").value.trim()
            };
        }

        // Validierung
        let errors = [];
        if (!name) errors.push("Der Name des Lieferanten ist erforderlich.");
        if (!telefon.match(/^\d{3,}$/)) errors.push("Telefonnummer muss mindestens 3 Ziffern enthalten.");
        if (!existingAddressId && (!adresse.strasse || !adresse.hausnummer || !adresse.plz.match(/^\d{5}$/) || !adresse.ortname)) {
            errors.push("Alle Adressfelder müssen ausgefüllt werden.");
        }

        if (errors.length > 0) {
            alert("Fehler:\n- " + errors.join("\n- "));
            return;
        }

        // API-Request
        try {
            const response = await fetch("/api/lieferant/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, telefon, ansprechpartner, adresse })
            });

            if (response.ok) {
                alert("Lieferant erfolgreich hinzugefügt!");
                location.reload();
            } else {
                const errorMessage = await response.text();
                alert("Fehler beim Hinzufügen des Lieferanten: " + errorMessage);
            }
        } catch (error) {
            alert("Serverfehler: " + error.message);
        }
    });


    document.getElementById("editFoodForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const id = document.getElementById("editId").value;
        const name = document.getElementById("editName").value;
        const menge = document.getElementById("editMenge").value;
        const lieferantId = document.getElementById("editLieferant").value;

        const response = await fetch("/api/food/edit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, name, menge, lieferantId })
        });

        if (response.ok) {
            alert("Futter erfolgreich bearbeitet!");
            location.reload();
        } else {
            const errorText = await response.text();
            alert("Fehler: " + errorText);
        }
    });
    document.getElementById("addFoodForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const name = document.getElementById("addName").value.trim();
        const menge = parseFloat(document.getElementById("addMenge").value);
        const lieferantId = document.getElementById("addLieferant").value;

        if (!name || isNaN(menge) || menge <= 0 || !lieferantId) {
            alert("Bitte alle Felder korrekt ausfüllen.");
            return;
        }

        const response = await fetch("/api/food/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, menge, lieferantId })
        });

        if (response.ok) {
            alert("Futter erfolgreich hinzugefügt.");
            location.reload();
        } else {
            const errorMsg = await response.text();
            alert("Fehler beim Hinzufügen des Futters: " + errorMsg);
        }
    });


</script>
<footer th:insert="~{vorlagen/footer :: footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
