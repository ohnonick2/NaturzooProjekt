<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futterplan verwalten</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-image: url('/images/background.png');
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            overflow-x: hidden;
        }
        .main-content { padding: 20px; }
        .card { border: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); padding: 20px; border-radius: 10px; background: white; }
        .header { background-color: #1f4e3e; color: white; padding: 15px; text-align: center; border-radius: 8px; }
        .btn-primary { background-color: #4a7c56; border-color: #4a7c56; }
        .list-group-item { display: flex; justify-content: space-between; align-items: center; }
        .remove-btn { color: red; cursor: pointer; font-size: 1.3em; }
        .remove-btn:hover { color: darkred; }
        .hidden { display: none; }
    </style>
</head>

<body>

<div class="main-content">
    <div class="header">
        <h2>Neuen Futterplan hinzuf√ºgen</h2>
    </div>

    <div class="card">
        <form id="addFutterplanForm">
            <div class="mb-3">
                <label for="name" class="form-label">Name des Futterplans</label>
                <input type="text" class="form-control" id="name" required>
            </div>

            <!-- Tierauswahl -->
            <div class="mb-3">
                <label class="form-label">Tierauswahl</label>
                <select class="form-select" id="haupt-dropdown" onchange="toggleTierRevierAuswahl()">
                    <option value="">Bitte ausw√§hlen...</option>
                    <option value="einzeltier">Einzelnes Tier ausw√§hlen</option>
                    <option value="revier">Nach Revier ausw√§hlen</option>
                </select>
            </div>

            <!-- Einzelnes Tier -->
            <div class="mb-3 hidden" id="einzeltier-men√º">
                <label class="form-label">Einzelnes Tier</label>
                <select class="form-select" id="tier-dropdown">
                    <option value="">Tier w√§hlen...</option>
                    <option th:each="tier : ${tiers}" th:value="${tier.id}" th:text="${tier.name}"></option>
                </select>
                <button type="button" class="btn btn-primary mt-2" onclick="addTier()">
                    <i class="fas fa-plus"></i> Hinzuf√ºgen
                </button>
            </div>

            <!-- Nach Revier -->
            <div class="mb-3 hidden" id="revier-men√º">
                <label class="form-label">Revier ausw√§hlen</label>
                <select class="form-select" id="revier-dropdown">
                    <option value="">Revier w√§hlen...</option>
                    <option th:each="revier : ${reviere}" th:value="${revier.id}" th:text="${revier.name}"></option>
                </select>
                <button type="button" class="btn btn-primary mt-2" onclick="addAllTiereAusRevier()">
                    <i class="fas fa-plus"></i> Alle Tiere hinzuf√ºgen
                </button>
            </div>

            <!-- Tierliste -->
            <ul id="tier-list" class="list-group mt-3"></ul>

            <!-- Futter hinzuf√ºgen -->
            <div class="mb-3">
                <label class="form-label">Futter hinzuf√ºgen</label>
                <div class="input-group">
                    <select class="form-select" id="futter-dropdown">
                        <option th:each="futter : ${verf√ºgbareFutterList}" th:value="${futter.id}" th:text="${futter.name}"></option>
                    </select>
                    <input type="number" class="form-control" id="futter-menge" min="1" placeholder="Menge (kg)">
                    <button type="button" class="btn btn-primary" onclick="addFutter()">
                        <i class="fas fa-plus"></i> Hinzuf√ºgen
                    </button>
                </div>
                <ul id="futter-list" class="list-group mt-2"></ul>
            </div>

            <!-- Uhrzeiten hinzuf√ºgen -->
            <div class="mb-3">
                <label class="form-label">Uhrzeiten hinzuf√ºgen</label>
                <div class="input-group">
                    <input type="time" class="form-control" id="global-time">
                    <button type="button" class="btn btn-primary" onclick="addGlobalTime()">
                        <i class="fas fa-plus"></i> Hinzuf√ºgen
                    </button>
                </div>
                <ul id="global-time-list" class="list-group mt-2"></ul>
            </div>

            <!-- Wochentage -->
            <div class="mb-3">
                <label class="form-label">Wochentage</label>
                <div class="d-flex flex-wrap">
                    <div th:each="wochentag : ${wochentagList}" class="form-check me-3">
                        <input class="form-check-input wochentag-checkbox" type="checkbox" th:value="${wochentag.id}">
                        <label class="form-check-label" th:text="${wochentag.name}"></label>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a th:href="@{/futterplan}" class="btn btn-secondary">Abbrechen</a>
                <button type="button" class="btn btn-primary" onclick="saveFutterplan()">Speichern</button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleTierRevierAuswahl() {
        document.getElementById("einzeltier-men√º").classList.add("hidden");
        document.getElementById("revier-men√º").classList.add("hidden");

        const selected = document.getElementById("haupt-dropdown").value;
        if (selected === "einzeltier") document.getElementById("einzeltier-men√º").classList.remove("hidden");
        else if (selected === "revier") document.getElementById("revier-men√º").classList.remove("hidden");
    }

    function addTier() {
        const select = document.getElementById('tier-dropdown');
        const list = document.getElementById('tier-list');
        const tierName = select.options[select.selectedIndex].text;

        if (!select.value) return alert("Bitte ein Tier ausw√§hlen.");

        const li = document.createElement("li");
        li.classList.add("list-group-item");
        li.innerHTML = `${tierName} <span class="remove-btn" onclick="this.parentElement.remove()"><i class="fas fa-trash-alt"></i></span>`;
        list.appendChild(li);
    }

    function addGlobalTime() {
        const input = document.getElementById("global-time");
        const list = document.getElementById("global-time-list");
        if (!input.value) return alert("Bitte eine Zeit eingeben.");

        const li = document.createElement("li");
        li.classList.add("list-group-item");
        li.innerHTML = `${input.value} <span class="remove-btn" onclick="this.parentElement.remove()"><i class="fas fa-trash-alt"></i></span>`;
        list.appendChild(li);
    }

    function addFutter() {
        const select = document.getElementById('futter-dropdown');
        const list = document.getElementById('futter-list');
        const menge = document.getElementById('futter-menge').value;
        if (!menge) return alert("Bitte eine Menge eingeben.");

        const li = document.createElement("li");
        li.classList.add("list-group-item");
        li.innerHTML = `${select.options[select.selectedIndex].text} - ${menge} kg <span class="remove-btn" onclick="this.parentElement.remove()"><i class="fas fa-trash-alt"></i></span>`;
        list.appendChild(li);
    }

    function saveFutterplan() {
        const name = document.getElementById("name").value;

        // üìÜ Wochentage erfassen
        const wochentage = Array.from(document.querySelectorAll(".wochentag-checkbox:checked"))
            .map(cb => parseInt(cb.value));

        // üïë Uhrzeiten erfassen
        const uhrzeiten = Array.from(document.querySelectorAll("#global-time-list .list-group-item span"))
            .map(span => span.textContent.trim());

        // üçΩÔ∏è Futter erfassen
        const futterList = Array.from(document.querySelectorAll("#futter-list .list-group-item"))
            .map(li => ({
                futterId: parseInt(li.dataset.futterId),
                menge: parseInt(li.dataset.menge) || 1
            }));

        // üêæ Einzelne Tiere erfassen
        const tiere = Array.from(document.querySelectorAll("#tier-list .list-group-item"))
            .map(li => parseInt(li.dataset.tierId));

        // üåø Revier erfassen
        const revierId = document.getElementById("revier-dropdown").value || null;

        // üõë Fehlerbehandlung
        if (!name) {
            alert("Bitte einen Namen f√ºr den Futterplan eingeben.");
            return;
        }
        if (wochentage.length === 0) {
            alert("Bitte mindestens einen Wochentag ausw√§hlen.");
            return;
        }
        if (uhrzeiten.length === 0) {
            alert("Bitte mindestens eine Uhrzeit hinzuf√ºgen.");
            return;
        }
        if (futterList.length === 0) {
            alert("Bitte mindestens ein Futter hinzuf√ºgen.");
            return;
        }

        // üì¶ JSON-Daten vorbereiten
        const futterplanData = {
            name,
            wochentage,
            uhrzeiten,
            futterList,
            tiere,
            revierId: revierId ? parseInt(revierId) : null
        };

        console.log("üì§ Sende JSON an Backend:", JSON.stringify(futterplanData));

        // üì° Daten an Backend senden
        fetch('/api/futterplan/add', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(futterplanData)
        })
            .then(response => response.text())
            .then(responseText => {
                alert(responseText);
                window.location.href = "/futterplan"; // üîÑ Erfolgreiche Weiterleitung
            })
            .catch(error => console.error("Fehler beim Speichern des Futterplans:", error));
    }


</script>

</body>
</html>
