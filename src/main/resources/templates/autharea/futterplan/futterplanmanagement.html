<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Futterplan Verwaltung – Rheiner Zoo</title>
    <!-- Bootstrap & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 0;
        }
        .main-content {
            margin-left: 250px; /* Platzhalter für Sidebar */
            padding: 20px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            background-color: #1f4e3e;
            color: #fff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .header h2 {
            margin: 0;
        }
        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .remove-btn {
            cursor: pointer;
            color: red;
            margin-left: 10px;
        }
        .table-sm th, .table-sm td {
            vertical-align: middle;
        }
    </style>
</head>
<body>

<!-- Sidebar (falls vorhanden) -->
<div th:insert="~{vorlagen/sidebar :: sidebar}"></div>

<div class="main-content">
    <div th:replace="~{vorlagen/header :: header(pageTitle='Futterplan Verwaltung - Rheiner Zoo')}"></div>


    <!-- Button: Neuer Futterplan -->
    <div class="action-buttons">
        <h4>Übersicht</h4>
        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addFutterplanModal">
            <i class="fas fa-plus"></i> Neuer Futterplan
        </button>
    </div>

    <!-- Suchfeld -->
    <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Futterplan suchen..." onkeyup="filterTable()">
    </div>

    <!-- Futterplan-Tabelle -->
    <div class="card p-3">
        <h4>Futterplan Übersicht</h4>
        <table class="table table-bordered" id="futterplanTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Futter</th>
                <th>Wochentage</th>
                <th>Uhrzeiten</th>
                <th>Pfleger</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="plan : ${futterplanList}">
                <td th:text="${plan.id}"></td>
                <td th:text="${plan.name}"></td>
                <td th:text="${plan.futter}">[Liste Futter/Mengen]</td>
                <td th:text="${plan.wochentage}">[Mo,Di,...]</td>
                <td th:text="${plan.futterZeiten}">[09:00,12:00]</td>

                <td>

                <div th:if="${plan.pflegerList.size() > 0}" th:each="pfleger : ${plan.pflegerList}">
                    <li th:text="${pfleger.benutzername}"></li>
                </div>
                 <div th:if="${plan.pflegerList.isEmpty()}">
                    <li>Keine Pfleger zugewiesen</li>
                </div>
                </td>

                <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            Aktionen
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" onclick="openEditModal(this)"
                                   th:data-id="${plan.id}"
                                   th:data-name="${plan.name}"
                                   th:data-futter="${plan.futter}"
                                   th:data-wochentage="${plan.wochentage}"
                                   th:data-zeiten="${plan.futterZeiten}"
                                   th:data-pfleger="${plan.getPflegerList()}">
                                    <i class="fas fa-edit"></i> Bearbeiten
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="#"
                                   onclick="deleteFutterplan(this)"
                                   th:data-id="${plan.id}">
                                    <i class="fas fa-trash"></i> Löschen
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL: Neuen Futterplan anlegen -->
<div class="modal fade" id="addFutterplanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Neuer Futterplan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFutterplanForm">
                    <label for="planName" class="form-label">Plan Name</label>
                    <input type="text" class="form-control mb-2" id="planName" required>

                    <!-- Wochentage (Checkboxen) – Alternative: "All" / "Assigned" 2-Tabellen -->
                    <label class="form-label">Wochentage auswählen</label>
                    <div>
                        <div class="form-check form-check-inline" th:each="tag : ${wochentagList}">
                            <input class="form-check-input" type="checkbox"
                                   th:id="'tag-' + ${tag.id}"
                                   th:value="${tag.id}"> <!-- ID statt Name, damit du es an /api schicken kannst -->
                            <label class="form-check-label" th:for="'tag-' + ${tag.id}" th:text="${tag.name}"></label>
                        </div>
                    </div>

                    <!-- Futter: Select + Menge -->
                    <label class="form-label mt-3">Futter hinzufügen</label>
                    <div class="input-group">
                        <select class="form-select" id="futterSelect">
                            <option th:each="futter : ${verfügbareFutterList}"
                                    th:value="${futter.id}"
                                    th:text="${futter.name}"></option>
                        </select>
                        <input type="number" class="form-control" id="futterMenge" min="1" placeholder="Menge (kg)">
                        <button type="button" class="btn btn-primary" id="addFutterItemBtn">+</button>
                    </div>
                    <ul class="list-group mt-2" id="futterItemList"></ul>

                    <!-- Fütterungszeiten (Time-Input) -->
                    <label class="form-label mt-3">Fütterungszeiten</label>
                    <div class="input-group">
                        <input type="time" class="form-control" id="timeInput">
                        <button type="button" class="btn btn-primary" id="addTimeBtn">+</button>
                    </div>
                    <ul class="list-group mt-2" id="timeItemList"></ul>

                    <!-- Pfleger – Du könntest auch 2-Tabellen-Ansatz machen. Hier nur Demo:  -->
                    <label class="form-label mt-3">Pfleger (IDs?)</label>
                    <input type="text" class="form-control mb-2" id="pflegerInput"
                           placeholder="z. B. 101, 102 – oder eigenes UI?">
                    <!-- oder du baust eine 2-Tabellen-Übersicht wie bei "assign caretaker" -->

                    <button type="submit" class="btn btn-success w-100 mt-3">Speichern</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Futterplan bearbeiten -->
<div class="modal fade" id="editFutterplanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Futterplan bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="editFutterplanForm">
                    <input type="hidden" id="editPlanId">

                    <label for="editPlanName" class="form-label">Plan Name</label>
                    <input type="text" class="form-control mb-2" id="editPlanName" required>

                    <!-- Wochentage / Futter / Zeiten / Pfleger -->
                    <!-- Entweder wie "add" – oder 2-Tabellen-Ansatz. Hier nur minimal. -->

                    <label class="form-label mt-3">Futter bearbeiten</label>
                    <div class="input-group">
                        <select class="form-select" id="editFutterSelect">
                            <option th:each="f : ${verfügbareFutterList}"
                                    th:value="${f.id}"
                                    th:text="${f.name}"></option>
                        </select>
                        <input type="number" class="form-control" id="editFutterMenge" min="1" placeholder="Menge (kg)">
                        <button type="button" class="btn btn-primary" id="editAddFutterItemBtn">+</button>
                    </div>
                    <ul class="list-group mt-2" id="editFutterItemList"></ul>

                    <label class="form-label mt-3">Fütterungszeiten</label>
                    <div class="input-group">
                        <input type="time" class="form-control" id="editTimeInput">
                        <button type="button" class="btn btn-primary" id="editAddTimeBtn">+</button>
                    </div>
                    <ul class="list-group mt-2" id="editTimeItemList"></ul>

                    <!-- Pfleger analog ... -->

                    <button type="submit" class="btn btn-primary w-100 mt-3">Änderungen speichern</button>
                </form>
            </div>

        </div>
    </div>
</div>
<table class="table" id="assignedPflegerTable">
    <tbody id="assignedPflegerBody"></tbody>
</table>
<table class="table" id="allPflegerTable">
    <tbody id="allPflegerBody"></tbody>
</table>
<!-- Bootstrap & JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --------------------------------------
    // 1) Such-Filter für Tabelle
    // --------------------------------------
    function filterTable() {
        const searchValue = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#futterplanTable tbody tr");
        rows.forEach(row => {
            const nameCell = row.getElementsByTagName("td")[1]; // 2. Spalte => Name
            const nameText = nameCell ? nameCell.textContent.toLowerCase() : "";
            row.style.display = nameText.includes(searchValue) ? "" : "none";
        });
    }
    // --------------------------------------------
    // Pfleger hinzufügen (ADD CARETAKER)
    // --------------------------------------------
    async function addPfleger(button) {
        const userId = button.getAttribute("data-id");
        const planId = document.getElementById("fplanId").value;

        if (!planId) {
            alert("Keine Plan-ID gefunden! Bitte erst einen Futterplan wählen oder erstellen.");
            return;
        }

        try {
            // 1) Server aufrufen
            const response = await fetch("/api/futterplan/caretakers/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ planId: parseInt(planId), userId: parseInt(userId) })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Hinzufügen: " + text);
                return;
            }

            // 2) DOM aktualisieren (z. B. Verschieben in "Assigned"-Tabelle)
            const row = button.closest("tr");
            const name = row.querySelector("td").textContent.trim();
            row.remove();

            const newTr = document.createElement("tr");
            newTr.setAttribute("data-user-id", userId);
            newTr.innerHTML = `
      <td>${name}</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="removePfleger(this)">
          <i class="fas fa-user-minus"></i>
        </button>
      </td>
    `;
            document.getElementById("assignedPflegerBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim addPfleger:", err);
            alert("Netzwerk- oder Serverfehler beim Hinzufügen des Pflegers!");
        }
    }

    // --------------------------------------------
    // Pfleger entfernen (REMOVE CARETAKER)
    // --------------------------------------------
    async function removePfleger(button) {
        const row = button.closest("tr");
        const userId = row.getAttribute("data-user-id");
        const planId = document.getElementById("fplanId").value;

        try {
            const response = await fetch("/api/futterplan/caretakers/remove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ planId: parseInt(planId), userId: parseInt(userId) })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Entfernen: " + text);
                return;
            }

            // DOM aktualisieren (zurück in "All-Pfleger" Tabelle)
            const name = row.querySelector("td").textContent.trim();
            row.remove();

            const newTr = document.createElement("tr");
            newTr.innerHTML = `
      <td>${name}</td>
      <td>
        <button class="btn btn-primary btn-sm" data-id="${userId}" onclick="addPfleger(this)">
          <i class="fas fa-user-plus"></i>
        </button>
      </td>
    `;
            document.getElementById("allPflegerBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim removePfleger:", err);
            alert("Netzwerk- oder Serverfehler beim Entfernen des Pflegers!");
        }
    }

    // --------------------------------------------
    // Wochentag hinzufügen (ADD WOCHENTAG)
    // --------------------------------------------
    async function addWochentag(button) {
        const wochentagId = button.getAttribute("data-id");
        const planId = document.getElementById("fplanId").value;

        try {
            const response = await fetch("/api/futterplan/wochentag/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ planId: parseInt(planId), wochentagId: parseInt(wochentagId) })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Hinzufügen: " + text);
                return;
            }

            // DOM
            const row = button.closest("tr");
            const tagName = row.querySelector("td").textContent.trim();
            row.remove();

            const newTr = document.createElement("tr");
            newTr.setAttribute("data-wochentag-id", wochentagId);
            newTr.innerHTML = `
      <td>${tagName}</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="removeWochentag(this)">
          <i class="fas fa-minus-circle"></i>
        </button>
      </td>
    `;
            document.getElementById("assignedWochentageBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim addWochentag:", err);
            alert("Netzwerk- oder Serverfehler beim Hinzufügen des Wochentags!");
        }
    }

    // --------------------------------------------
    // Wochentag entfernen (REMOVE WOCHENTAG)
    // --------------------------------------------
    async function removeWochentag(button) {
        const row = button.closest("tr");
        const wochentagId = row.getAttribute("data-wochentag-id");
        const planId = document.getElementById("fplanId").value;

        try {
            const response = await fetch("/api/futterplan/wochentag/remove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ planId: parseInt(planId), wochentagId: parseInt(wochentagId) })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Entfernen: " + text);
                return;
            }

            const tagName = row.querySelector("td").textContent.trim();
            row.remove();

            const newTr = document.createElement("tr");
            newTr.innerHTML = `
      <td>${tagName}</td>
      <td>
        <button class="btn btn-primary btn-sm" data-id="${wochentagId}" onclick="addWochentag(this)">
          <i class="fas fa-plus-circle"></i>
        </button>
      </td>
    `;
            document.getElementById("allWochentageBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim removeWochentag:", err);
            alert("Netzwerk- oder Serverfehler beim Entfernen des Wochentags!");
        }
    }

    // --------------------------------------------
    // Futter hinzufügen (ADD FUTTER)
    // --------------------------------------------
    async function addFutter(button) {
        const futterId = button.getAttribute("data-id");
        const planId = document.getElementById("fplanId").value;
        const row = button.closest("tr");
        const mengeInput = row.querySelector("input");
        const mengeVal = parseFloat(mengeInput.value) || 0;

        if (mengeVal <= 0) {
            alert("Bitte eine Menge > 0 eingeben!");
            return;
        }

        try {
            const response = await fetch("/api/futterplan/futter/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    planId: parseInt(planId),
                    futterId: parseInt(futterId),
                    menge: mengeVal
                })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Hinzufügen: " + text);
                return;
            }

            // DOM
            const futterName = button.getAttribute("data-name");
            row.remove();

            const newTr = document.createElement("tr");
            newTr.setAttribute("data-futter-id", futterId);
            newTr.setAttribute("data-futter-menge", mengeVal);
            newTr.innerHTML = `
      <td>${futterName}</td>
      <td>${mengeVal} kg</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="removeFutter(this)">
          <i class="fas fa-minus-circle"></i>
        </button>
      </td>
    `;
            document.getElementById("assignedFutterBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim addFutter:", err);
            alert("Netzwerk- oder Serverfehler beim Hinzufügen von Futter!");
        }
    }

    // --------------------------------------------
    // Futter entfernen (REMOVE FUTTER)
    // --------------------------------------------
    async function removeFutter(button) {
        const row = button.closest("tr");
        const futterId = row.getAttribute("data-futter-id");
        const mengeVal = parseFloat(row.getAttribute("data-futter-menge")) || 0;
        const planId = document.getElementById("fplanId").value;

        try {
            const response = await fetch("/api/futterplan/futter/remove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    planId: parseInt(planId),
                    futterId: parseInt(futterId)
                })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Entfernen: " + text);
                return;
            }

            // DOM
            const futterName = row.querySelector("td").textContent.trim();
            row.remove();

            const newTr = document.createElement("tr");
            newTr.innerHTML = `
      <td>
        ${futterName}
        <input type="number" step="0.1" min="0" value="${mengeVal}"
               class="form-control form-control-sm"
               style="width:80px; display:inline-block; margin-left:10px;"
               placeholder="Menge">
      </td>
      <td>
        <button class="btn btn-primary btn-sm"
                data-id="${futterId}"
                data-name="${futterName}"
                onclick="addFutter(this)">
          <i class="fas fa-plus-circle"></i>
        </button>
      </td>
    `;
            document.getElementById("allFutterBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim removeFutter:", err);
            alert("Netzwerk- oder Serverfehler beim Entfernen von Futter!");
        }
    }

    // --------------------------------------------
    // Futterzeit hinzufügen (ADD FUTTERZEIT)
    // --------------------------------------------
    async function addFutterzeit(button) {
        const timeId = button.getAttribute("data-id");
        const planId = document.getElementById("fplanId").value;

        try {
            const response = await fetch("/api/futterplan/futterzeit/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ planId: parseInt(planId), futterzeitId: parseInt(timeId) })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Hinzufügen: " + text);
                return;
            }

            // DOM
            const row = button.closest("tr");
            const timeText = button.getAttribute("data-time");
            row.remove();

            const newTr = document.createElement("tr");
            newTr.setAttribute("data-time-id", timeId);
            newTr.innerHTML = `
      <td>${timeText}</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="removeFutterzeit(this)">
          <i class="fas fa-minus-circle"></i>
        </button>
      </td>
    `;
            document.getElementById("assignedTimesBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim addFutterzeit:", err);
            alert("Netzwerk- oder Serverfehler beim Hinzufügen einer Futterzeit!");
        }
    }

    // --------------------------------------------
    // Futterzeit entfernen (REMOVE FUTTERZEIT)
    // --------------------------------------------
    async function removeFutterzeit(button) {
        const row = button.closest("tr");
        const timeId = row.getAttribute("data-time-id");
        const planId = document.getElementById("fplanId").value;

        try {
            const response = await fetch("/api/futterplan/futterzeit/remove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ planId: parseInt(planId), futterzeitId: parseInt(timeId) })
            });
            const text = await response.text();
            if (!response.ok) {
                alert("Fehler beim Entfernen: " + text);
                return;
            }

            // DOM
            const timeText = row.querySelector("td").textContent.trim();
            row.remove();

            const newTr = document.createElement("tr");
            newTr.innerHTML = `
      <td>${timeText}</td>
      <td>
        <button class="btn btn-primary btn-sm"
                data-id="${timeId}"
                data-time="${timeText}"
                onclick="addFutterzeit(this)">
          <i class="fas fa-plus-circle"></i>
        </button>
      </td>
    `;
            document.getElementById("allTimesBody").appendChild(newTr);

        } catch (err) {
            console.error("Fehler beim removeFutterzeit:", err);
            alert("Netzwerk- oder Serverfehler beim Entfernen einer Futterzeit!");
        }
    }


</script>
</body>
</html>
